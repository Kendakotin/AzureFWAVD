<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kendaks Guide: Securing Azure Virtual Desktop with Azure Firewall in a Hub-and-Spoke Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Canela:wght@300;400;700&amp;family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        .font-canela {
            font-family: 'Canela', serif;
        }

        .font-inter {
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #1e40af;
            --secondary: #64748b;
            --accent: #0ea5e9;
            --neutral: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
        }

        .toc-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            z-index: 1000;
            padding: 2rem 1.5rem;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: center;
            min-height: 500px;
        }

        .bento-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .highlight-box {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid var(--accent);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .step-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .citation-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px dotted var(--accent);
        }

        .citation-link:hover {
            color: var(--primary);
            border-bottom: 1px solid var(--primary);
        }

        .toc-link {
            display: block;
            padding: 0.5rem 0;
            color: var(--text-secondary);
            text-decoration: none;
            border-left: 2px solid transparent;
            padding-left: 1rem;
            transition: all 0.2s ease;
        }

        .toc-link:hover,
        .toc-link.active {
            color: var(--primary);
            border-left-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .toc-link.level-2 {
            padding-left: 2rem;
            font-size: 0.9rem;
        }

        .toc-link.level-3 {
            padding-left: 3rem;
            font-size: 0.85rem;
        }

        .architecture-diagram {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid #e2e8f0;
            margin: 2rem 0;
        }

        /* Mermaid diagram styling */
        .mermaid-container {
            display: flex;
            justify-content: center;
            min-height: 300px;
            max-height: 800px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .mermaid-container .mermaid {
            width: 100%;
            max-width: 100%;
            height: 100%;
            cursor: grab;
            transition: transform 0.3s ease;
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            /* Èò≤Ê≠¢Ëß¶Êë∏ËÆæÂ§á‰∏äÁöÑÈªòËÆ§Ë°å‰∏∫ */
            -webkit-user-select: none;
            /* Èò≤Ê≠¢ÊñáÊú¨ÈÄâÊã© */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .mermaid-container .mermaid svg {
            max-width: 100%;
            height: 100%;
            display: block;
            margin: 0 auto;
        }

        .mermaid-container .mermaid:active {
            cursor: grabbing;
        }

        .mermaid-container.zoomed .mermaid {
            height: 100%;
            width: 100%;
            cursor: grab;
        }

        .mermaid-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .mermaid-control-btn {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
            font-size: 14px;
            min-width: 36px;
            height: 36px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mermaid-control-btn:hover {
            background: #f8fafc;
            border-color: #3b82f6;
            color: #3b82f6;
            transform: translateY(-1px);
        }

        .mermaid-control-btn:active {
            transform: scale(0.95);
        }

        /* Enhanced mermaid node styling for better contrast */
        .mermaid .node rect {
            stroke-width: 2px !important;
        }

        .mermaid .node text {
            fill: var(--text-primary) !important;
            font-weight: 600 !important;
            font-size: 14px !important;
        }

        .mermaid .edgeLabel {
            background-color: var(--neutral) !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
        }

        .mermaid .edgeLabel text {
            fill: var(--text-primary) !important;
        }

        /* Responsive adjustments for mermaid controls */
        @media (max-width: 1024px) {
            .mermaid-control-btn:not(.reset-zoom) {
                display: none;
            }

            .mermaid-controls {
                top: auto;
                bottom: 15px;
                right: 15px;
            }
        }

        /* Responsive adjustments for small screens */
        @media (max-width: 768px) {
            .hero-grid {
                grid-template-columns: 1fr;
            }

            .hero-grid img {
                display: none;
            }

            .main-content {
                padding: 1rem;
            }

            .step-card {
                padding: 1rem;
            }

            .toc-fixed {
                display: none;
            }

            .mermaid-container {
                padding: 15px;
            }

            .bento-card {
                padding: 1rem;
            }
        }
    </style>
    <base target="_blank">
</head>

<body class="bg-gray-50 font-inter" style="overflow-x: hidden;">
    <!-- Fixed Table of Contents -->
    <div class="toc-fixed">
        <div class="mb-8">
            <h3 class="font-canela text-lg font-bold text-slate-800 mb-4">Contents</h3>
            <nav class="space-y-1">
                <a href="#introduction" class="toc-link">1. Introduction &amp; Architecture</a>
                <a href="#hub-spoke-model" class="toc-link level-2">1.1. Hub-and-Spoke Model</a>
                <a href="#avd-topology" class="toc-link level-2">1.2. AVD in Hub-and-Spoke</a>
                <a href="#architecture-diagram" class="toc-link level-2">1.3. Architecture Diagram</a>

                <a href="#prerequisites" class="toc-link">2. Prerequisites &amp; Planning</a>
                <a href="#subscriptions" class="toc-link level-2">2.1. Azure Subscriptions</a>
                <a href="#network-design" class="toc-link level-2">2.2. Network Design</a>
                <a href="#identity-management" class="toc-link level-2">2.3. Identity Management</a>

                <a href="#step1-network" class="toc-link">3. Step 1: Network Architecture</a>
                <a href="#create-hub" class="toc-link level-2">3.1. Creating Hub VNet</a>
                <a href="#create-spoke" class="toc-link level-2">3.2. Creating Spoke VNet</a>
                <a href="#vnet-peering" class="toc-link level-2">3.3. VNet Peering</a>

                <a href="#step2-firewall" class="toc-link">4. Step 2: Azure Firewall</a>
                <a href="#deploy-firewall" class="toc-link level-2">4.1. Deploying Firewall</a>
                <a href="#configure-udr" class="toc-link level-2">4.2. Configuring UDRs</a>
                <a href="#routing-considerations" class="toc-link level-2">4.3. Routing Considerations</a>

                <a href="#step3-avd" class="toc-link">5. Step 3: AVD Deployment</a>
                <a href="#create-host-pool" class="toc-link level-2">5.1. Creating Host Pool</a>
                <a href="#add-session-hosts" class="toc-link level-2">5.2. Adding Session Hosts</a>
                <a href="#app-groups" class="toc-link level-2">5.3. Application Groups</a>

                <a href="#firewall-rules" class="toc-link">6. Firewall Configuration</a>
                <a href="#fqdn-tags" class="toc-link level-2">6.1. FQDN Tags</a>
                <a href="#network-rules" class="toc-link level-2">6.2. Network Rules</a>
                <a href="#application-rules" class="toc-link level-2">6.3. Application Rules</a>

                <a href="#integration" class="toc-link">7. Service Integration</a>
                <a href="#azure-bastion" class="toc-link level-2">7.1. Azure Bastion</a>
                <a href="#hybrid-connectivity" class="toc-link level-2">7.2. Hybrid Connectivity</a>

                <a href="#conclusion" class="toc-link">8. Conclusion</a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Hero Section -->
        <section class="bg-gradient-to-br from-slate-50 to-blue-50 py-16 px-8">
            <div class="max-w-7xl mx-auto">
                <div class="hero-grid">
                    <div class="space-y-6">
                        <h1
                            class="font-canela text-4xl lg:text-5xl xl:text-6xl font-light text-slate-900 leading-tight">
                            <em class="text-blue-600">Kendaks Guide: Secure AVD</em>
                            <br />
                            with Azure Firewall in a
                            <br />
                            Hub-and-Spoke Architecture
                        </h1>
                        <p class="text-xl text-slate-600 leading-relaxed">
                            A comprehensive guide to deploying enterprise-grade virtual desktop infrastructure with
                            centralized security controls, network segmentation, and best practices for scalable cloud
                            architecture.
                        </p>
                        <div class="flex items-center space-x-4 text-sm text-slate-500">
                            <span class="flex items-center"><i class="fas fa-network-wired mr-2"></i>Network
                                Architecture</span>
                            <span class="flex items-center"><i class="fas fa-shield-alt mr-2"></i>Security</span>
                            <span class="flex items-center"><i class="fas fa-desktop mr-2"></i>Virtual Desktop</span>
                        </div>
                    </div>
                    <div class="relative">
                        <img src="https://kimi-web-img.moonshot.cn/img/learn.microsoft.com/5d1250ef8c02b7743d83db0e38a97e3285c6b724.png"
                            alt="Azure hub and spoke network architecture"
                            class="w-full h-80 object-cover rounded-xl shadow-lg" size="medium" aspect="wide"
                            style="photo" query="Azure hub and spoke network topology" referrerpolicy="no-referrer"
                            data-modified="1" data-score="0.00" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent rounded-xl"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Key Highlights -->
        <section class="py-12 px-8 bg-white">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bento-card">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-sitemap text-blue-600 text-2xl mr-3"></i>
                            <h3 class="font-canela text-lg font-semibold">Hub-and-Spoke Model</h3>
                        </div>
                        <p class="text-slate-600">Centralized security enforcement with isolated workload networks for
                            scalable enterprise architecture.</p>
                    </div>
                    <div class="bento-card">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-fire text-orange-500 text-2xl mr-3"></i>
                            <h3 class="font-canela text-lg font-semibold">Azure Firewall</h3>
                        </div>
                        <p class="text-slate-600">Stateful firewall inspection with FQDN-based filtering and centralized
                            policy management.</p>
                    </div>
                    <div class="bento-card">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-desktop text-green-600 text-2xl mr-3"></i>
                            <h3 class="font-canela text-lg font-semibold">AVD Integration</h3>
                        </div>
                        <p class="text-slate-600">Secure virtual desktop deployment with reverse connect technology and
                            Microsoft 365 integration.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Introduction -->
        <section id="introduction" class="py-16 px-8">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-4xl font-light text-slate-900 mb-8">Introduction and Architecture Overview
                </h2>

                <div class="prose prose-lg max-w-none">
                    <p class="text-lg text-slate-700 leading-relaxed mb-6">
                        This guide provides a comprehensive, step-by-step process for deploying and securing an Azure
                        Virtual Desktop (AVD) environment using Azure Firewall within a hub-and-spoke network
                        architecture. This model is a cornerstone of enterprise cloud networking, offering a scalable,
                        secure, and manageable way to isolate workloads while enforcing centralized security policies.
                    </p>

                    <div class="highlight-box">
                        <h4 class="font-semibold text-slate-800 mb-3">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                            Key Architecture Principles
                        </h4>
                        <ul class="space-y-2 text-slate-700">
                            <li><strong>Centralized Security:</strong> All traffic flows through Azure Firewall for
                                inspection and policy enforcement</li>
                            <li><strong>Network Isolation:</strong> AVD session hosts in dedicated spoke VNet with
                                limited blast radius</li>
                            <li><strong>Reverse Connect:</strong> No inbound RDP ports required - enhanced security
                                posture</li>
                            <li><strong>Scalable Design:</strong> Support for hybrid connectivity and future expansion
                            </li>
                        </ul>
                    </div>

                    <p class="text-slate-700 leading-relaxed">
                        By placing AVD session hosts in a spoke virtual network (VNet) and routing all traffic through a
                        central Azure Firewall in the hub VNet, organizations can gain granular control over network
                        flows, inspect traffic for threats, and simplify management. This document covers the entire
                        lifecycle, from initial network planning and architecture design to the detailed configuration
                        of network components, firewall rules, and AVD-specific settings.
                    </p>
                </div>
            </div>
        </section>

        <!-- Hub-and-Spoke Model -->
        <section id="hub-spoke-model" class="py-16 px-8 bg-slate-50">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Understanding the Hub-and-Spoke Model
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <div>
                        <h3 class="font-canela text-xl font-semibold text-slate-800 mb-4">Benefits of Centralized
                            Network Security</h3>
                        <p class="text-slate-700 mb-4">
                            The hub-and-spoke network topology is a widely adopted architectural pattern in Azure that
                            provides a structured approach to network design, enhancing security, scalability, and
                            operational efficiency <a
                                href="https://learn.microsoft.com/en-us/azure/architecture/networking/architecture/hub-spoke"
                                class="citation-link">[183]</a>.
                        </p>
                        <ul class="space-y-2 text-slate-700">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                <span><strong>Consistent Policy Enforcement:</strong> Single point of security policy
                                    management</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                <span><strong>Single Pane of Glass:</strong> Comprehensive visibility for monitoring and
                                    logging <a
                                        href="https://simonvedder.com/using-azure-firewall-as-a-nva-with-terraform/"
                                        class="citation-link">[175]</a></span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                <span><strong>Simplified Management:</strong> Reduced operational overhead with
                                    centralized appliances</span>
                            </li>
                        </ul>
                    </div>

                    <div>
                        <img src="https://fixedplaceholder" alt="Azure hub and spoke network topology"
                            class="w-full h-64 object-cover rounded-lg shadow-md" size="medium" aspect="wide"
                            query="Azure hub and spoke network diagram" referrerpolicy="no-referrer" data-modified="1"
                            data-score="0.00" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="step-card">
                        <h4 class="font-semibold text-slate-800 mb-3">
                            <i class="fas fa-server text-blue-600 mr-2"></i>
                            Hub VNet (Shared Services)
                        </h4>
                        <ul class="space-y-2 text-slate-700">
                            <li>‚Ä¢ Azure Firewall for centralized security</li>
                            <li>‚Ä¢ VPN/ExpressRoute Gateway for hybrid connectivity</li>
                            <li>‚Ä¢ Active Directory Domain Services</li>
                            <li>‚Ä¢ DNS servers and NTP services <a
                                    href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/scenarios/azure-virtual-desktop/eslz-network-topology-and-connectivity"
                                    class="citation-link">[180]</a>
                            </li>
                        </ul>
                    </div>

                    <div class="step-card">
                        <h4 class="font-semibold text-slate-800 mb-3">
                            <i class="fas fa-sitemap text-green-600 mr-2"></i>
                            Spoke VNet (Isolated Workloads)
                        </h4>
                        <ul class="space-y-2 text-slate-700">
                            <li>‚Ä¢ AVD session hosts in dedicated subnet</li>
                            <li>‚Ä¢ Application-specific environments</li>
                            <li>‚Ä¢ Limited blast radius for security breaches</li>
                            <li>‚Ä¢ Independent team management <a
                                    href="https://learn.microsoft.com/en-us/azure/well-architected/azure-virtual-desktop/networking"
                                    class="citation-link">[171]</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Architecture Diagram -->
        <section id="architecture-diagram" class="py-16 px-8">
            <div class="max-w-6xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">High-Level Architecture Diagram</h2>

                <div class="architecture-diagram">
                    <h3 class="font-semibold text-slate-800 mb-6 text-center">AVD Hub-and-Spoke Network Architecture
                    </h3>

                    <div class="mermaid-container">
                        <div class="mermaid-controls">
                            <button class="mermaid-control-btn zoom-in" title="ÊîæÂ§ß">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="mermaid-control-btn zoom-out" title="Áº©Â∞è">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="mermaid-control-btn reset-zoom" title="ÈáçÁΩÆ">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                            <button class="mermaid-control-btn fullscreen" title="ÂÖ®Â±èÊü•Áúã">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        <div class="mermaid" id="architecture-mermaid">
                            graph TB
                            subgraph &#34;User Access&#34;
                            UD[&#34;üë§ User&#39;s Device
                            <br />Remote Desktop Client&#34;]
                            AVD_CP[&#34;‚òÅÔ∏è AVD Control Plane
                            <br />Gateway, Broker
                            <br />Managed by Microsoft&#34;]
                            end

                            subgraph &#34;Hub VNet: 10.0.0.0/16&#34;
                            AF[&#34;üîí Azure Firewall
                            <br />AzureFirewallSubnet
                            <br />10.0.0.0/26&#34;]
                            AB[&#34;üíª Azure Bastion
                            <br />BastionSubnet
                            <br />10.0.1.0/26&#34;]
                            GW[&#34;üåê VPN/ExpressRoute
                            <br />GatewaySubnet&#34;]
                            end

                            subgraph &#34;Spoke VNet: 10.1.0.0/16&#34;
                            AVD_SUB[&#34;üñ•Ô∏è AVD Session Hosts Subnet
                            <br />10.1.0.0/24&#34;]
                            AVD_VMs[&#34;üíª AVD Session Host VMs&#34;]
                            UDR[&#34;üìù UDR: 0.0.0.0/0 ‚Üí Firewall IP&#34;]
                            end

                            subgraph &#34;On-Premises&#34;
                            ON_PREM[&#34;üè¢ Corporate Network
                            <br />Domain Controllers
                            <br />File Servers&#34;]
                            end

                            UD -.-&gt;|HTTPS:443| AVD_CP
                            AVD_CP -.-&gt;|&#34;Reverse Connect&#34;| AVD_VMs

                            AVD_VMs --&gt;|Outbound Traffic| UDR
                            UDR --&gt;|Forced Tunneling| AF
                            AF --&gt;|Internet| Internet[(&#34;üåê Internet&#34;)]
                            AF --&gt;|Microsoft 365| M365[&#34;üìß Microsoft 365 Services&#34;]

                            ON_PREM -.-&gt;|VPN/ExpressRoute| GW
                            GW --&gt;|Hybrid Traffic| AF

                            AB -.-&gt;|Secure RDP/SSH| AVD_VMs

                            classDef userStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#0d47a1
                            classDef hubStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
                            classDef spokeStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#1b5e20
                            classDef onpremStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#e65100
                            classDef serviceStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#880e4f
                            classDef internetStyle fill:#e1f5fe,stroke:#0288d1,stroke-width:2px,color:#01579b

                            class UD,AVD_CP userStyle
                            class AF,AB,GW hubStyle
                            class AVD_SUB,AVD_VMs,UDR spokeStyle
                            class ON_PREM onpremStyle
                            class M365 serviceStyle
                            class Internet internetStyle
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                        <div>
                            <h4 class="font-semibold text-slate-800 mb-3">Data Flow Paths</h4>
                            <div class="space-y-3 text-sm text-slate-700">
                                <div class="flex items-center p-2 bg-blue-50 rounded">
                                    <i class="fas fa-arrow-up text-blue-600 mr-2"></i>
                                    <span><strong>User ‚Üí AVD:</strong> HTTPS (443) to control plane</span>
                                </div>
                                <div class="flex items-center p-2 bg-green-50 rounded">
                                    <i class="fas fa-arrow-down text-green-600 mr-2"></i>
                                    <span><strong>Reverse Connect:</strong> Session host initiates outbound</span>
                                </div>
                                <div class="flex items-center p-2 bg-orange-50 rounded">
                                    <i class="fas fa-arrow-up text-orange-600 mr-2"></i>
                                    <span><strong>Outbound Traffic:</strong> Through firewall for inspection</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-800 mb-3">Integration Points</h4>
                            <ul class="space-y-2 text-sm text-slate-700">
                                <li class="flex items-center"><i
                                        class="fas fa-shield-alt text-purple-600 mr-2"></i>Azure Bastion for secure
                                    admin access</li>
                                <li class="flex items-center"><i
                                        class="fas fa-network-wired text-blue-600 mr-2"></i>VPN/ExpressRoute for hybrid
                                    connectivity <a
                                        href="https://docs.azure.cn/en-us/firewall/tutorial-hybrid-portal-policy"
                                        class="citation-link">[20]</a>
                                </li>
                                <li class="flex items-center"><i class="fas fa-route text-green-600 mr-2"></i>UDR for
                                    traffic steering to firewall</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Prerequisites -->
        <section id="prerequisites" class="py-16 px-8 bg-slate-50">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Prerequisites and Planning</h2>

                <div class="step-card">
                    <h3 id="subscriptions" class="font-canela text-xl font-semibold text-slate-800 mb-4">Required Azure
                        Subscriptions and Permissions</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-3">Azure Subscription Requirements</h4>
                            <ul class="space-y-2 text-slate-700">
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-600 mt-1 mr-2"></i>
                                    <span>Sufficient vCPU and RAM quotas for AVD session hosts</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-600 mt-1 mr-2"></i>
                                    <span>Public IP addresses for Azure Firewall and Bastion</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-600 mt-1 mr-2"></i>
                                    <span>VNet peering capacity and firewall data processing <a
                                            href="https://learn.microsoft.com/en-us/azure/virtual-network-manager/how-to-deploy-hub-spoke-topology-with-azure-firewall"
                                            class="citation-link">[54]</a></span>
                                </li>
                            </ul>
                        </div>

                        <div>
                            <h4 class="font-semibold text-slate-700 mb-3">Required RBAC Roles</h4>
                            <ul class="space-y-2 text-slate-700">
                                <li class="flex items-start">
                                    <i class="fas fa-user-shield text-blue-600 mt-1 mr-2"></i>
                                    <span><strong>Contributor</strong> role for resource creation</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-network-wired text-blue-600 mt-1 mr-2"></i>
                                    <span><code>Microsoft.Network/*</code> permissions</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-desktop text-blue-600 mt-1 mr-2"></i>
                                    <span><code>Microsoft.DesktopVirtualization/*</code> permissions</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="network-design" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-4">Network Design and IP Addressing
                    </h3>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-2">IP Address Space Planning</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <strong>Hub VNet:</strong>
                                    <br />
                                    <code>10.0.0.0/16</code> (65,536 addresses)
                                    <br />
                                    <span class="text-slate-600">AzureFirewallSubnet: 10.0.0.0/26</span>
                                </div>
                                <div>
                                    <strong>Spoke VNet:</strong>
                                    <br />
                                    <code>10.1.0.0/16</code> (65,536 addresses)
                                    <br />
                                    <span class="text-slate-600">AVD-SessionHosts: 10.1.0.0/24</span>
                                </div>
                            </div>
                        </div>

                        <div class="highlight-box">
                            <h4 class="font-semibold text-slate-800 mb-2">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                Critical Requirements
                            </h4>
                            <ul class="space-y-1 text-slate-700">
                                <li>‚Ä¢ No IP address overlap between hub, spoke, and on-premises networks</li>
                                <li>‚Ä¢ AzureFirewallSubnet must be minimum /26 (64 IP addresses) <a
                                        href="https://notes.kodekloud.com/docs/Microsoft-Azure-Security-Technologies-AZ-500/Perimeter-Security/Implementing-Azure-Firewall"
                                        class="citation-link">[32]</a>
                                </li>
                                <li>‚Ä¢ Proper subnet sizing for future growth and scaling</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="identity-management" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-4">Identity and Access Management
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-slate-800 mb-2">Azure AD Tenant</h5>
                            <p class="text-sm text-slate-700">Mandatory for AVD authentication and user access control
                                <a href="https://petri.com/azure-virtual-desktop/" class="citation-link">[98]</a>
                            </p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-slate-800 mb-2">Hybrid Identity</h5>
                            <p class="text-sm text-slate-700">Azure AD Connect for on-premises AD synchronization if
                                needed <a
                                    href="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/azure-virtual-desktop/azure-virtual-desktop"
                                    class="citation-link">[93]</a>
                            </p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-slate-800 mb-2">User Groups</h5>
                            <p class="text-sm text-slate-700">Azure AD security groups for AVD access management and
                                role-based access</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 1: Network Architecture -->
        <section id="step1-network" class="py-16 px-8">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Step 1: Creating the Hub-and-Spoke
                    Network Architecture</h2>

                <div id="create-hub" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Creating the Hub Virtual Network
                    </h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-4">Hub VNet Configuration</h4>
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <table class="w-full text-sm">
                                    <tbody>
                                        <tr class="border-b">
                                            <td class="py-2 font-medium">Subscription</td>
                                            <td>Your Azure Subscription</td>
                                        </tr>
                                        <tr class="border-b">
                                            <td class="py-2 font-medium">Resource Group</td>
                                            <td>RG-Hub-Spoke-Network</td>
                                        </tr>
                                        <tr class="border-b">
                                            <td class="py-2 font-medium">VNet Name</td>
                                            <td>VNet-Hub-EastUS-001</td>
                                        </tr>
                                        <tr class="border-b">
                                            <td class="py-2 font-medium">Region</td>
                                            <td>East US</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 font-medium">Address Space</td>
                                            <td>10.0.0.0/16</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h4 class="font-semibold text-slate-700 mb-3">Subnet Configuration</h4>
                            <ul class="space-y-2 text-sm text-slate-700">
                                <li class="flex items-center">
                                    <i class="fas fa-fire text-red-600 mr-2"></i>
                                    <span><strong>AzureFirewallSubnet:</strong> 10.0.0.0/26 (minimum size) <a
                                            href="https://microsoftlearning.github.io/Configure-secure-access-to-workloads-with-Azure-virtual-networking-services/Instructions/Labs/LAB_01_virtual_networks.html"
                                            class="citation-link">[37]</a></span>
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-server text-blue-600 mr-2"></i>
                                    <span><strong>GatewaySubnet:</strong> For VPN/ExpressRoute</span>
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                                    <span><strong>AzureBastionSubnet:</strong> Optional secure admin access</span>
                                </li>
                            </ul>
                        </div>

                        <div>
                            <img src="https://kimi-web-img.moonshot.cn/img/learn.microsoft.com/efcc3bf358dd0d5ad96d42896af1a5576d3fa065.png"
                                alt="Azure Virtual Network configuration interface"
                                class="w-full h-64 object-cover rounded-lg shadow-md mb-4" size="medium" aspect="wide"
                                style="photo" query="Azure Virtual Network creation screen" referrerpolicy="no-referrer"
                                data-modified="1" data-score="0.00" />
                            <p class="text-sm text-slate-600 italic">Hub VNet creation in Azure Portal with proper
                                subnet configuration</p>
                        </div>
                    </div>
                </div>

                <div id="create-spoke" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Creating the Spoke Virtual Network
                        for AVD</h3>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-3">Spoke VNet Configuration</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <strong>Basic Settings:</strong>
                                    <ul class="text-sm space-y-1 mt-2">
                                        <li>Name: VNet-AVD-Spoke-EastUS-001</li>
                                        <li>Region: East US (same as Hub)</li>
                                        <li>Address Space: 10.1.0.0/16</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>AVD Subnet:</strong>
                                    <ul class="text-sm space-y-1 mt-2">
                                        <li>Name: AVD-SessionHosts</li>
                                        <li>Address Range: 10.1.0.0/24</li>
                                        <li>Usable IPs: 251 (after Azure reservations) <a
                                                href="https://dev.to/willvelida/implementing-a-basic-azure-virtual-network-with-bicep-31fj"
                                                class="citation-link">[38]</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="highlight-box">
                            <h4 class="font-semibold text-slate-800 mb-2">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                Best Practice: Dedicated AVD Subnet
                            </h4>
                            <p class="text-slate-700">Create a separate subnet for AVD session hosts rather than placing
                                them in a shared subnet. This allows for specific NSG rules and UDRs to be applied to
                                the AVD workload independently.</p>
                        </div>
                    </div>
                </div>

                <div id="vnet-peering" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Configuring VNet Peering</h3>

                    <div class="space-y-6">
                        <div class="bg-purple-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">Bidirectional Peering Configuration</h4>
                            <p class="text-sm text-slate-700 mb-4">VNet peering is non-transitive - requires two
                                separate peering connections for bidirectional communication <a
                                    href="https://medium.com/azure-hub/azure-hub-and-spoke-topology-how-to-configure-multi-spoke-connectivity-4c817bd4ac38"
                                    class="citation-link">[29]</a>.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded border">
                                    <h5 class="font-medium text-slate-800 mb-2">
                                        <i class="fas fa-arrow-right text-blue-600 mr-2"></i>
                                        Hub-to-Spoke
                                    </h5>
                                    <ul class="text-sm space-y-1">
                                        <li>Peering Name: Hub-to-AVD-Spoke</li>
                                        <li>Allow Gateway Transit: Enabled</li>
                                        <li>Allow Forwarded Traffic: Enabled</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded border">
                                    <h5 class="font-medium text-slate-800 mb-2">
                                        <i class="fas fa-arrow-left text-green-600 mr-2"></i>
                                        Spoke-to-Hub
                                    </h5>
                                    <ul class="text-sm space-y-1">
                                        <li>Peering Name: AVD-Spoke-to-Hub</li>
                                        <li>Use Remote Gateways: Enabled</li>
                                        <li>Allow Forwarded Traffic: Enabled</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <h5 class="font-semibold text-slate-800 mb-2">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                Critical Settings for Hybrid Connectivity
                            </h5>
                            <p class="text-sm text-slate-700">&#34;Allow gateway transit&#34; (Hub) and &#34;Use remote
                                gateways&#34; (Spoke) must both be enabled for AVD session hosts to communicate with
                                on-premises resources through the Hub&#39;s VPN/ExpressRoute gateway.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 2: Azure Firewall -->
        <section id="step2-firewall" class="py-16 px-8 bg-slate-50">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Step 2: Deploying and Configuring Azure
                    Firewall</h2>

                <div id="deploy-firewall" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Deploying Azure Firewall in Hub
                        VNet</h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-4">Firewall Deployment Steps</h4>
                            <ol class="space-y-3 text-slate-700">
                                <li class="flex items-start">
                                    <span
                                        class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">1</span>
                                    <span>Navigate to Azure Firewall in Azure Portal</span>
                                </li>
                                <li class="flex items-start">
                                    <span
                                        class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">2</span>
                                    <span>Select Hub VNet and AzureFirewallSubnet</span>
                                </li>
                                <li class="flex items-start">
                                    <span
                                        class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">3</span>
                                    <span>Assign public IP address for management</span>
                                </li>
                                <li class="flex items-start">
                                    <span
                                        class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">4</span>
                                    <span>Configure firewall policy and threat intelligence</span>
                                </li>
                            </ol>

                            <div class="mt-6 p-4 bg-green-50 rounded-lg">
                                <h5 class="font-semibold text-slate-800 mb-2">Firewall Requirements</h5>
                                <ul class="text-sm space-y-1 text-slate-700">
                                    <li>‚Ä¢ Dedicated subnet named exactly &#34;AzureFirewallSubnet&#34;</li>
                                    <li>‚Ä¢ Minimum /26 subnet size (64 IP addresses)</li>
                                    <li>‚Ä¢ Public IP address for management access</li>
                                    <li>‚Ä¢ Firewall policy for rule configuration</li>
                                </ul>
                            </div>
                        </div>

                        <div>
                            <img src="https://fixedplaceholder"
                                alt="Azure Firewall deployment interface in Azure Portal"
                                class="w-full h-64 object-cover rounded-lg shadow-md mb-4" size="medium" aspect="wide"
                                style="photo" query="Azure Firewall creation screen" referrerpolicy="no-referrer"
                                data-modified="1" data-score="0.00" />
                            <p class="text-sm text-slate-600 italic">Azure Firewall deployment in dedicated subnet
                                within Hub VNet</p>
                        </div>
                    </div>
                </div>

                <div id="configure-udr" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Configuring User-Defined Routes
                        (UDRs)</h3>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">Route Table Configuration Process</h4>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div
                                        class="bg-white rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-table text-blue-600 text-2xl"></i>
                                    </div>
                                    <h5 class="font-semibold text-slate-800 mb-2">Create Route Table</h5>
                                    <p class="text-sm text-slate-600">Create route table resource in same region as
                                        Spoke VNet</p>
                                </div>
                                <div class="text-center">
                                    <div
                                        class="bg-white rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-route text-green-600 text-2xl"></i>
                                    </div>
                                    <h5 class="font-semibold text-slate-800 mb-2">Add Default Route</h5>
                                    <p class="text-sm text-slate-600">0.0.0.0/0 ‚Üí Firewall private IP address</p>
                                </div>
                                <div class="text-center">
                                    <div
                                        class="bg-white rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-link text-purple-600 text-2xl"></i>
                                    </div>
                                    <h5 class="font-semibold text-slate-800 mb-2">Associate Subnet</h5>
                                    <p class="text-sm text-slate-600">Link route table to AVD session host subnet</p>
                                </div>
                            </div>
                        </div>

                        <div class="highlight-box">
                            <h4 class="font-semibold text-slate-800 mb-3">
                                <i class="fas fa-route text-blue-600 mr-2"></i>
                                Default Route Configuration
                            </h4>
                            <div class="bg-white p-4 rounded border-l-4 border-blue-500">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <strong>Address Prefix:</strong>
                                        <br />
                                        <code>0.0.0.0/0</code>
                                    </div>
                                    <div>
                                        <strong>Next Hop Type:</strong>
                                        <br />
                                        <code>Virtual Appliance</code>
                                    </div>
                                    <div>
                                        <strong>Next Hop Address:</strong>
                                        <br />
                                        <code>Firewall Private IP</code>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-600 mt-2">This configuration forces all non-local traffic
                                    through the Azure Firewall for inspection</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="routing-considerations" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Important Considerations for AVD
                        Traffic Routing</h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-red-50 border-l-4 border-red-400 p-4">
                            <h4 class="font-semibold text-slate-800 mb-3">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                Warning: Potential AVD Disconnections
                            </h4>
                            <p class="text-sm text-slate-700">
                                Applying a default UDR (0.0.0.0/0) without corresponding firewall rules will cause AVD
                                connections to fail. The AVD reverse connect model requires specific outbound
                                connections to service endpoints <a
                                    href="https://johanvanneuville.com/avd/configure-avd-traffic-on-azure-firewall-with-ip-groups-and-terraform-part-1/"
                                    class="citation-link">[176]</a>.
                            </p>
                        </div>

                        <div class="bg-green-50 border-l-4 border-green-400 p-4">
                            <h4 class="font-semibold text-slate-800 mb-3">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                Solution: Specific Route for AVD Traffic
                            </h4>
                            <p class="text-sm text-slate-700">
                                Create a route with <code>WindowsVirtualDesktop</code> service tag destination and
                                &#34;Internet&#34; next hop to bypass firewall for AVD control plane traffic. This
                                ensures service availability while maintaining security for other traffic.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 3: AVD Deployment -->
        <section id="step3-avd" class="py-16 px-8">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Step 3: Deploying Azure Virtual Desktop
                    (AVD)</h2>

                <div id="create-host-pool" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Creating the AVD Host Pool</h3>

                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-slate-700 mb-4">Host Pool Types</h4>
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-slate-800 mb-2">
                                            <i class="fas fa-users text-blue-600 mr-2"></i>
                                            Pooled Host Pool
                                        </h5>
                                        <p class="text-sm text-slate-700 mb-2">Multiple users share session hosts -
                                            cost-effective for standardized desktop environments</p>
                                        <div class="text-xs text-slate-600">
                                            <strong>Load Balancing:</strong> Breadth-first or depth-first algorithms
                                        </div>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-slate-800 mb-2">
                                            <i class="fas fa-user text-green-600 mr-2"></i>
                                            Personal Host Pool
                                        </h5>
                                        <p class="text-sm text-slate-700 mb-2">Each user has dedicated session host -
                                            for administrative rights or persistent environments</p>
                                        <div class="text-xs text-slate-600">
                                            <strong>Use Case:</strong> Power users requiring custom configurations
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-slate-700 mb-4">Configuration Process</h4>
                                <ol class="space-y-3 text-slate-700">
                                    <li class="flex items-start">
                                        <span
                                            class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">1</span>
                                        <span>Navigate to Azure Virtual Desktop in portal</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span
                                            class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">2</span>
                                        <span>Click &#34;Create host pool&#34; and select resource group</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span
                                            class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">3</span>
                                        <span>Choose host pool type and load balancing algorithm</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span
                                            class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">4</span>
                                        <span>Configure maximum session limit and drain mode</span>
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="add-session-hosts" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Adding Session Hosts to the Host
                        Pool</h3>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">Session Host Configuration Workflow</h4>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5 class="font-medium text-slate-800 mb-3">Network Configuration</h5>
                                    <ul class="space-y-2 text-sm text-slate-700">
                                        <li class="flex items-center">
                                            <i class="fas fa-network-wired text-blue-600 mr-2"></i>
                                            <span>Select Spoke VNet: VNet-AVD-Spoke-EastUS-001</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-sitemap text-blue-600 mr-2"></i>
                                            <span>Choose subnet: AVD-SessionHosts (10.1.0.0/24)</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-route text-blue-600 mr-2"></i>
                                            <span>Inherit UDR from subnet for firewall routing</span>
                                        </li>
                                    </ul>
                                </div>

                                <div>
                                    <h5 class="font-medium text-slate-800 mb-3">VM Configuration</h5>
                                    <ul class="space-y-2 text-sm text-slate-700">
                                        <li class="flex items-center">
                                            <i class="fas fa-image text-green-600 mr-2"></i>
                                            <span>Choose image: Windows 10/11 Enterprise multi-session</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-microchip text-green-600 mr-2"></i>
                                            <span>Select VM size based on user requirements</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-calculator text-green-600 mr-2"></i>
                                            <span>Specify number of instances for user capacity</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="highlight-box">
                            <h4 class="font-semibold text-slate-800 mb-3">
                                <i class="fas fa-users-cog text-blue-600 mr-2"></i>
                                Domain Join Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded border">
                                    <h5 class="font-medium text-slate-800 mb-2">Azure AD Join</h5>
                                    <p class="text-sm text-slate-700">Simple cloud-native option with Azure AD
                                        credentials</p>
                                </div>
                                <div class="bg-white p-4 rounded border">
                                    <h5 class="font-medium text-slate-800 mb-2">Hybrid AD Join</h5>
                                    <p class="text-sm text-slate-700">Requires VPN/ExpressRoute connectivity to
                                        on-premises domain controllers <a
                                            href="https://docs.azure.cn/en-us/virtual-desktop/prerequisites"
                                            class="citation-link">[167]</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="app-groups" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Creating Application Groups and
                        Workspaces</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">
                                <i class="fas fa-desktop text-blue-600 mr-2"></i>
                                Desktop Application Group
                            </h4>
                            <p class="text-sm text-slate-700 mb-3">Provides users with full desktop sessions on session
                                hosts</p>
                            <ul class="space-y-1 text-sm text-slate-700">
                                <li>‚Ä¢ Associated with specific host pool</li>
                                <li>‚Ä¢ User-friendly display name for clients</li>
                                <li>‚Ä¢ Azure AD user/group assignments</li>
                                <li>‚Ä¢ Complete desktop experience</li>
                            </ul>
                        </div>

                        <div class="bg-green-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">
                                <i class="fas fa-window-maximize text-green-600 mr-2"></i>
                                RemoteApp Application Group
                            </h4>
                            <p class="text-sm text-slate-700 mb-3">Publishes individual applications instead of full
                                desktops</p>
                            <ul class="space-y-1 text-sm text-slate-700">
                                <li>‚Ä¢ Specific application publishing</li>
                                <li>‚Ä¢ Reduced resource consumption</li>
                                <li>‚Ä¢ Enhanced security posture</li>
                                <li>‚Ä¢ Line-of-business application focus</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-purple-50 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-3">
                            <i class="fas fa-users text-purple-600 mr-2"></i>
                            User Assignment Best Practices
                        </h4>
                        <ul class="space-y-2 text-sm text-slate-700">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                <span>Use Azure AD security groups instead of individual users for simplified
                                    management</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                <span>Create role-based groups (e.g., &#34;AVD-Users-Finance&#34;,
                                    &#34;AVD-Users-Engineering&#34;)</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                <span>Align with principle of least privilege based on user responsibilities</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Firewall Configuration -->
        <section id="firewall-rules" class="py-16 px-8 bg-slate-50">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Firewall Configuration for AVD Traffic
                </h2>

                <div id="fqdn-tags" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Configuring FQDN Tags</h3>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">
                                <i class="fas fa-tag text-blue-600 mr-2"></i>
                                WindowsVirtualDesktop FQDN Tag
                            </h4>
                            <p class="text-slate-700 mb-4">
                                Azure Firewall provides FQDN tags to simplify the configuration of required AVD service
                                endpoints. The <code>WindowsVirtualDesktop</code> tag includes all necessary FQDNs for
                                AVD control plane communication <a
                                    href="https://learn.microsoft.com/en-us/azure/firewall/protect-azure-virtual-desktop"
                                    class="citation-link">[46]</a>.
                            </p>

                            <div class="bg-white p-4 rounded border-l-4 border-blue-500">
                                <h5 class="font-medium text-slate-800 mb-2">Application Rule Configuration</h5>
                                <div class="text-sm space-y-1">
                                    <div><strong>Name:</strong> Allow-AVD-FQDN-Tags</div>
                                    <div><strong>Source:</strong> 10.1.0.0/24 (AVD subnet)</div>
                                    <div><strong>Protocol:</strong> HTTP, HTTPS</div>
                                    <div><strong>Target FQDN:</strong> WindowsVirtualDesktop</div>
                                    <div><strong>Action:</strong> Allow</div>
                                </div>
                            </div>
                        </div>

                        <div class="highlight-box">
                            <h4 class="font-semibold text-slate-800 mb-3">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                Benefits of FQDN Tags
                            </h4>
                            <ul class="space-y-2 text-slate-700">
                                <li>‚Ä¢ Automatic updates when AVD service endpoints change</li>
                                <li>‚Ä¢ Eliminates need to manage individual IP addresses</li>
                                <li>‚Ä¢ Simplified firewall rule management</li>
                                <li>‚Ä¢ Ensures AVD service connectivity remains functional</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="network-rules" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Network Rules Configuration</h3>

                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-green-50 p-6 rounded-lg">
                                <h4 class="font-semibold text-slate-800 mb-4">
                                    <i class="fas fa-portrait text-green-600 mr-2"></i>
                                    Microsoft 365 Services
                                </h4>
                                <p class="text-sm text-slate-700 mb-3">Allow access to Microsoft 365 services for
                                    productivity applications</p>
                                <div class="text-xs space-y-1">
                                    <div><strong>Source:</strong> AVD subnet (10.1.0.0/24)</div>
                                    <div><strong>Destination:</strong> M365 service tag</div>
                                    <div><strong>Ports:</strong> TCP 80, 443, 587</div>
                                </div>
                            </div>

                            <div class="bg-purple-50 p-6 rounded-lg">
                                <h4 class="font-semibold text-slate-800 mb-4">
                                    <i class="fas fa-windows text-purple-600 mr-2"></i>
                                    Windows Update
                                </h4>
                                <p class="text-sm text-slate-700 mb-3">Enable Windows Update for security patches and
                                    updates</p>
                                <div class="text-xs space-y-1">
                                    <div><strong>Source:</strong> AVD subnet (10.1.0.0/24)</div>
                                    <div><strong>Destination:</strong> WindowsUpdate service tag</div>
                                    <div><strong>Ports:</strong> TCP 80, 443</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <h4 class="font-semibold text-slate-800 mb-2">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                Important Security Considerations
                            </h4>
                            <ul class="text-sm space-y-1 text-slate-700">
                                <li>‚Ä¢ Limit outbound internet access to required services only</li>
                                <li>‚Ä¢ Use web categories for content filtering if needed</li>
                                <li>‚Ä¢ Consider time-based rules for maintenance windows</li>
                                <li>‚Ä¢ Implement logging and monitoring for all firewall rules</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="application-rules" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Application Rules Configuration
                    </h3>

                    <div class="space-y-6">
                        <div class="bg-orange-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">Required AVD Endpoints</h4>
                            <p class="text-sm text-slate-700 mb-4">
                                In addition to FQDN tags, specific application rules may be needed for custom or
                                additional services <a
                                    href="https://learn.microsoft.com/en-us/azure/virtual-desktop/required-fqdn-endpoint"
                                    class="citation-link">[168]</a>.
                            </p>

                            <div class="bg-white p-4 rounded border">
                                <h5 class="font-medium text-slate-800 mb-2">Common AVD-Related FQDNs</h5>
                                <div class="text-xs space-y-1">
                                    <div>‚Ä¢ *.wvd.microsoft.com</div>
                                    <div>‚Ä¢ *.windowsvirtualdesktop.com</div>
                                    <div>‚Ä¢ *.azure.com</div>
                                    <div>‚Ä¢ *.microsoftonline.com</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <i class="fas fa-shield-alt text-blue-600 text-2xl mb-2"></i>
                                <h5 class="font-semibold text-slate-800 mb-2">Security Priority</h5>
                                <p class="text-xs text-slate-700">Allow only required traffic, deny everything else by
                                    default</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <i class="fas fa-chart-line text-green-600 text-2xl mb-2"></i>
                                <h5 class="font-semibold text-slate-800 mb-2">Performance</h5>
                                <p class="text-xs text-slate-700">Optimize rules for minimal processing overhead and
                                    latency</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <i class="fas fa-cogs text-purple-600 text-2xl mb-2"></i>
                                <h5 class="font-semibold text-slate-800 mb-2">Maintainability</h5>
                                <p class="text-xs text-slate-700">Document rules clearly and review regularly for
                                    optimization</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Integration Section -->
        <section id="integration" class="py-16 px-8">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Service Integration</h2>

                <div id="azure-bastion" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Azure Bastion Integration</h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-4">Secure Administrative Access</h4>
                            <p class="text-slate-700 mb-4">
                                Azure Bastion provides secure RDP and SSH access to virtual machines without exposing
                                public IP addresses. This is a critical security best practice for administrative access
                                to AVD session hosts.
                            </p>

                            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                <h5 class="font-semibold text-slate-800 mb-2">Bastion Deployment Options</h5>
                                <ul class="space-y-2 text-sm text-slate-700">
                                    <li class="flex items-start">
                                        <i class="fas fa-server text-blue-600 mr-2 mt-1"></i>
                                        <div>
                                            <strong>Hub VNet Deployment:</strong> Centralized administrative access
                                            point for all spoke VNets
                                        </div>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-sitemap text-green-600 mr-2 mt-1"></i>
                                        <div>
                                            <strong>Spoke VNet Deployment:</strong> Dedicated admin access for specific
                                            workload teams
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <h5 class="font-semibold text-slate-800 mb-2">
                                    <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                                    NSG Configuration Requirements
                                </h5>
                                <p class="text-sm text-slate-700">Network Security Group on AVD subnet must allow RDP
                                    traffic (TCP 3389) from the AzureBastionSubnet.</p>
                            </div>
                        </div>

                        <div>
                            <img src="https://fixedplaceholder" alt="Azure Bastion deployed in Azure Virtual Network"
                                class="w-full h-64 object-cover rounded-lg shadow-md mb-4" size="medium" aspect="wide"
                                style="photo" query="Azure Bastion service in Azure Portal" referrerpolicy="no-referrer"
                                data-modified="1" data-score="0.00" />
                            <p class="text-sm text-slate-600 italic">Azure Bastion deployment options for secure
                                administrative access</p>
                        </div>
                    </div>
                </div>

                <div id="hybrid-connectivity" class="step-card">
                    <h3 class="font-canela text-xl font-semibold text-slate-800 mb-6">Hybrid Connectivity Options</h3>

                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 p-6 rounded-lg">
                                <h4 class="font-semibold text-slate-800 mb-4">
                                    <i class="fas fa-network-wired text-blue-600 mr-2"></i>
                                    VPN Gateway
                                </h4>
                                <p class="text-sm text-slate-700 mb-3">Site-to-Site VPN connectivity for on-premises
                                    integration</p>
                                <ul class="space-y-1 text-xs text-slate-700">
                                    <li>‚Ä¢ IKEv1 and IKEv2 protocol support</li>
                                    <li>‚Ä¢ Multiple authentication methods</li>
                                    <li>‚Ä¢ Route-based and policy-based VPNs</li>
                                    <li>‚Ä¢ Cost-effective solution for smaller deployments</li>
                                </ul>
                            </div>

                            <div class="bg-green-50 p-6 rounded-lg">
                                <h4 class="font-semibold text-slate-800 mb-4">
                                    <i class="fas fa-rocket text-green-600 mr-2"></i>
                                    ExpressRoute
                                </h4>
                                <p class="text-sm text-slate-700 mb-3">Dedicated private connectivity to Azure</p>
                                <ul class="space-y-1 text-xs text-slate-700">
                                    <li>‚Ä¢ Private, dedicated network path</li>
                                    <li>‚Ä¢ Consistent latency and performance</li>
                                    <li>‚Ä¢ Higher bandwidth options (up to 100 Gbps)</li>
                                    <li>‚Ä¢ Enterprise-grade SLA and support</li>
                                </ul>
                            </div>
                        </div>

                        <div class="highlight-box">
                            <h4 class="font-semibold text-slate-800 mb-3">
                                <i class="fas fa-route text-blue-600 mr-2"></i>
                                Gateway Transit Configuration
                            </h4>
                            <p class="text-slate-700 mb-4">
                                For AVD session hosts to communicate with on-premises resources, proper gateway transit
                                configuration is essential:
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded border">
                                    <h5 class="font-medium text-slate-800 mb-2">Hub VNet Peering Settings</h5>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Allow gateway transit: Enabled</li>
                                        <li>‚Ä¢ Allow forwarded traffic: Enabled</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded border">
                                    <h5 class="font-medium text-slate-800 mb-2">Spoke VNet Peering Settings</h5>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Use remote gateways: Enabled</li>
                                        <li>‚Ä¢ Allow forwarded traffic: Enabled</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="bg-orange-50 border-l-4 border-orange-400 p-4">
                            <h4 class="font-semibold text-slate-800 mb-2">
                                <i class="fas fa-exclamation-triangle text-orange-600 mr-2"></i>
                                Firewall Integration Requirements
                            </h4>
                            <p class="text-sm text-slate-700">
                                Ensure that traffic from the GatewaySubnet is routed through the Azure Firewall for
                                inspection by configuring a UDR on the GatewaySubnet with 0.0.0.0/0 pointing to the
                                firewall&#39;s private IP <a
                                    href="https://docs.azure.cn/en-us/firewall/tutorial-hybrid-portal-policy"
                                    class="citation-link">[20]</a>.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Conclusion -->
        <section id="conclusion" class="py-16 px-8 bg-slate-50">
            <div class="max-w-4xl mx-auto">
                <h2 class="font-canela text-3xl font-light text-slate-900 mb-8">Conclusion</h2>

                <div class="step-card">
                    <div class="space-y-6">
                        <p class="text-lg text-slate-700 leading-relaxed">
                            Deploying Azure Virtual Desktop within a hub-and-spoke architecture with Azure Firewall
                            provides a robust, scalable, and secure solution for enterprise virtual desktop
                            infrastructure. This architecture addresses key security and management challenges while
                            providing the flexibility needed for modern cloud environments.
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-blue-50 p-6 rounded-lg text-center">
                                <i class="fas fa-shield-alt text-blue-600 text-3xl mb-4"></i>
                                <h4 class="font-semibold text-slate-800 mb-2">Security</h4>
                                <p class="text-sm text-slate-700">Centralized firewall inspection with granular policy
                                    control and threat protection</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg text-center">
                                <i class="fas fa-expand-arrows-alt text-green-600 text-3xl mb-4"></i>
                                <h4 class="font-semibold text-slate-800 mb-2">Scalability</h4>
                                <p class="text-sm text-slate-700">Hub-and-spoke model supports growth with isolated
                                    workloads and centralized management</p>
                            </div>
                            <div class="bg-purple-50 p-6 rounded-lg text-center">
                                <i class="fas fa-cogs text-purple-600 text-3xl mb-4"></i>
                                <h4 class="font-semibold text-slate-800 mb-2">Manageability</h4>
                                <p class="text-sm text-slate-700">Single pane of glass for monitoring with simplified
                                    policy enforcement</p>
                            </div>
                        </div>

                        <div class="bg-gray-100 p-6 rounded-lg">
                            <h4 class="font-semibold text-slate-800 mb-4">Key Implementation Takeaways</h4>
                            <ul class="space-y-2 text-slate-700">
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                    <span>Proper network design with non-overlapping IP address spaces is fundamental to
                                        success</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                    <span>User-Defined Routes must be carefully configured to avoid AVD service
                                        disruptions</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                    <span>Azure Firewall rules should be tested thoroughly before production
                                        deployment</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                    <span>Integration with Azure Bastion enhances security for administrative
                                        access</span>
                                </li>
                            </ul>
                        </div>

                        <div class="highlight-box">
                            <h4 class="font-semibold text-slate-800 mb-3">
                                <i class="fas fa-road text-blue-600 mr-2"></i>
                                Next Steps
                            </h4>
                            <p class="text-slate-700 mb-4">
                                With the foundational architecture in place, consider these additional enhancements:
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <ul class="space-y-2 text-slate-700">
                                    <li>‚Ä¢ Implement Azure Monitor for comprehensive logging</li>
                                    <li>‚Ä¢ Configure backup solutions for session hosts</li>
                                    <li>‚Ä¢ Set up automated scaling for host pools</li>
                                </ul>
                                <ul class="space-y-2 text-slate-700">
                                    <li>‚Ä¢ Deploy application security groups</li>
                                    <li>‚Ä¢ Implement disaster recovery plans</li>
                                    <li>‚Ä¢ Establish operational runbooks and procedures</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Table of Contents active link tracking
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -80% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Remove active class from all TOC links
                    document.querySelectorAll('.toc-link').forEach(link => {
                        link.classList.remove('active');
                    });

                    // Add active class to current section's TOC link
                    const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active');
                    }
                }
            });
        }, observerOptions);

        // Observe all sections with IDs
        document.querySelectorAll('section[id], div[id]').forEach(section => {
            observer.observe(section);
        });

        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#ffffff',
                primaryTextColor: '#0f172a',
                primaryBorderColor: '#64748b',
                lineColor: '#64748b',
                secondaryColor: '#f8fafc',
                tertiaryColor: '#f1f5f9',
                background: '#ffffff',
                mainBkg: '#ffffff',
                secondBkg: '#f8fafc',
                tertiaryBkg: '#f1f5f9',
                fontFamily: 'Inter, sans-serif',
                fontSize: '14px'
            },
            flowchart: {
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            }
        });

        // Initialize Mermaid Controls for zoom and pan
        function initializeMermaidControls() {
            const containers = document.querySelectorAll('.mermaid-container');

            containers.forEach(container => {
                const mermaidElement = container.querySelector('.mermaid');
                let scale = 1;
                let isDragging = false;
                let startX, startY, translateX = 0, translateY = 0;

                // Ëß¶Êë∏Áõ∏ÂÖ≥Áä∂ÊÄÅ
                let isTouch = false;
                let touchStartTime = 0;
                let initialDistance = 0;
                let initialScale = 1;
                let isPinching = false;

                // Zoom controls
                const zoomInBtn = container.querySelector('.zoom-in');
                const zoomOutBtn = container.querySelector('.zoom-out');
                const resetBtn = container.querySelector('.reset-zoom');
                const fullscreenBtn = container.querySelector('.fullscreen');

                function updateTransform() {
                    mermaidElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;

                    if (scale > 1) {
                        container.classList.add('zoomed');
                    } else {
                        container.classList.remove('zoomed');
                    }

                    mermaidElement.style.cursor = isDragging ? 'grabbing' : 'grab';
                }

                if (zoomInBtn) {
                    zoomInBtn.addEventListener('click', () => {
                        scale = Math.min(scale * 1.25, 4);
                        updateTransform();
                    });
                }

                if (zoomOutBtn) {
                    zoomOutBtn.addEventListener('click', () => {
                        scale = Math.max(scale / 1.25, 0.3);
                        if (scale <= 1) {
                            translateX = 0;
                            translateY = 0;
                        }
                        updateTransform();
                    });
                }

                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        scale = 1;
                        translateX = 0;
                        translateY = 0;
                        updateTransform();
                    });
                }

                if (fullscreenBtn) {
                    fullscreenBtn.addEventListener('click', () => {
                        if (container.requestFullscreen) {
                            container.requestFullscreen();
                        } else if (container.webkitRequestFullscreen) {
                            container.webkitRequestFullscreen();
                        } else if (container.msRequestFullscreen) {
                            container.msRequestFullscreen();
                        }
                    });
                }

                // Mouse Events
                mermaidElement.addEventListener('mousedown', (e) => {
                    if (isTouch) return; // Â¶ÇÊûúÊòØËß¶Êë∏ËÆæÂ§áÔºåÂøΩÁï•Èº†Ê†á‰∫ã‰ª∂

                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    mermaidElement.style.cursor = 'grabbing';
                    updateTransform();
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging && !isTouch) {
                        translateX = e.clientX - startX;
                        translateY = e.clientY - startY;
                        updateTransform();
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging && !isTouch) {
                        isDragging = false;
                        mermaidElement.style.cursor = 'grab';
                        updateTransform();
                    }
                });

                document.addEventListener('mouseleave', () => {
                    if (isDragging && !isTouch) {
                        isDragging = false;
                        mermaidElement.style.cursor = 'grab';
                        updateTransform();
                    }
                });

                // Ëé∑Âèñ‰∏§ÁÇπ‰πãÈó¥ÁöÑË∑ùÁ¶ª
                function getTouchDistance(touch1, touch2) {
                    return Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                }

                // Touch Events - Ëß¶Êë∏‰∫ã‰ª∂Â§ÑÁêÜ
                mermaidElement.addEventListener('touchstart', (e) => {
                    isTouch = true;
                    touchStartTime = Date.now();

                    if (e.touches.length === 1) {
                        // ÂçïÊåáÊãñÂä®
                        isPinching = false;
                        isDragging = true;

                        const touch = e.touches[0];
                        startX = touch.clientX - translateX;
                        startY = touch.clientY - translateY;

                    } else if (e.touches.length === 2) {
                        // ÂèåÊåáÁº©Êîæ
                        isPinching = true;
                        isDragging = false;

                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        initialDistance = getTouchDistance(touch1, touch2);
                        initialScale = scale;
                    }

                    e.preventDefault();
                }, { passive: false });

                mermaidElement.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 1 && isDragging && !isPinching) {
                        // ÂçïÊåáÊãñÂä®
                        const touch = e.touches[0];
                        translateX = touch.clientX - startX;
                        translateY = touch.clientY - startY;
                        updateTransform();

                    } else if (e.touches.length === 2 && isPinching) {
                        // ÂèåÊåáÁº©Êîæ
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const currentDistance = getTouchDistance(touch1, touch2);

                        if (initialDistance > 0) {
                            const newScale = Math.min(Math.max(
                                initialScale * (currentDistance / initialDistance),
                                0.3
                            ), 4);
                            scale = newScale;
                            updateTransform();
                        }
                    }

                    e.preventDefault();
                }, { passive: false });

                mermaidElement.addEventListener('touchend', (e) => {
                    // ÈáçÁΩÆÁä∂ÊÄÅ
                    if (e.touches.length === 0) {
                        isDragging = false;
                        isPinching = false;
                        initialDistance = 0;

                        // Âª∂ËøüÈáçÁΩÆisTouchÔºåÈÅøÂÖçÈº†Ê†á‰∫ã‰ª∂Á´ãÂç≥Ëß¶Âèë
                        setTimeout(() => {
                            isTouch = false;
                        }, 100);
                    } else if (e.touches.length === 1 && isPinching) {
                        // ‰ªéÂèåÊåáÂèò‰∏∫ÂçïÊåáÔºåÂàáÊç¢‰∏∫ÊãñÂä®Ê®°Âºè
                        isPinching = false;
                        isDragging = true;

                        const touch = e.touches[0];
                        startX = touch.clientX - translateX;
                        startY = touch.clientY - translateY;
                    }

                    updateTransform();
                });

                mermaidElement.addEventListener('touchcancel', (e) => {
                    isDragging = false;
                    isPinching = false;
                    initialDistance = 0;

                    setTimeout(() => {
                        isTouch = false;
                    }, 100);

                    updateTransform();
                });

                // Enhanced wheel zoom with better center point handling
                container.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const rect = container.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;

                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    const newScale = Math.min(Math.max(scale * delta, 0.3), 4);

                    // Adjust translation to zoom towards center
                    if (newScale !== scale) {
                        const scaleDiff = newScale / scale;
                        translateX = translateX * scaleDiff;
                        translateY = translateY * scaleDiff;
                        scale = newScale;

                        if (scale <= 1) {
                            translateX = 0;
                            translateY = 0;
                        }

                        updateTransform();
                    }
                });

                // Initialize display
                updateTransform();
            });
        }

        // Initialize the mermaid controls when the DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            initializeMermaidControls();
        });
    </script>


</body>

</html>